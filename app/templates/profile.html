{% extends "base.html" %}

{% block content %}
<div class="container mt-5 mb-5">
    <h2>User Profile</h2>
    <p>Welcome, <span id="displayUsername" class="fw-bold"></span>!</p>
    
    <div class="card p-4 mb-4">
        <h4>Edit Details</h4>
        <form id="profileForm">
            <div class="mb-3">
                <label class="form-label">Biography</label>
                <textarea class="form-control" id="bio" rows="3" placeholder="Tell us about yourself"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Location</label>
                <input type="text" class="form-control" id="location" placeholder="City, Country">
            </div>
            <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-success">Update Profile</button>
                <a href="/login-ui" class="btn btn-secondary">Logout</a>
            </div>
        </form>
        <div id="message" class="mt-3"></div>
    </div>

    <div class="card p-4 mb-4 border-warning">
        <h4>Change Password</h4>
        <form id="passwordForm">
            <div class="mb-3">
                <label class="form-label">Old Password</label>
                <input type="password" id="oldPassword" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label">New Password</label>
                <input type="password" id="newPassword" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-warning text-white">Update Password</button>
        </form>
        <div id="pwdMessage" class="mt-3"></div>
    </div>

    <div class="card p-4 border-danger">
        <h4 class="text-danger">Danger Zone</h4>
        <p>Once you delete your account, there is no going back.</p>
        <button id="deleteBtn" class="btn btn-danger">Delete Account</button>
    </div>
</div>

<script>
    const userId = localStorage.getItem('user_id');
    const username = localStorage.getItem('username');

    if (!userId) {
        window.location.href = '/login-ui';
    }

    document.getElementById('displayUsername').innerText = username;

    // 1. Load Data
    async function loadProfile() {
        const response = await fetch(`/users/${userId}`);
        if (response.ok) {
            const data = await response.json();
            document.getElementById('bio').value = data.bio || '';
            document.getElementById('location').value = data.location || '';
        }
    }

    // 2. Handle Profile Update
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const bio = document.getElementById('bio').value;
        const location = document.getElementById('location').value;

        const response = await fetch(`/users/${userId}/profile`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bio, location })
        });
        const msgDiv = document.getElementById('message');
        if (response.ok) {
            msgDiv.innerHTML = '<div class="alert alert-success">Profile Updated!</div>';
        } else {
            msgDiv.innerHTML = '<div class="alert alert-danger">Update Failed</div>';
        }
    });

    // 3. Handle Password Change (NEW!)
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const old_password = document.getElementById('oldPassword').value;
        const new_password = document.getElementById('newPassword').value;

        const response = await fetch(`/users/${userId}/password`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ old_password, new_password })
        });

        const msgDiv = document.getElementById('pwdMessage');
        if (response.ok) {
            msgDiv.innerHTML = '<div class="alert alert-success">Password Changed!</div>';
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPassword').value = '';
        } else {
            const data = await response.json();
            msgDiv.innerHTML = `<div class="alert alert-danger">${data.detail || 'Failed'}</div>`;
        }
    });

    // 4. Handle Delete
    document.getElementById('deleteBtn').addEventListener('click', async () => {
        if(confirm("Are you sure? This cannot be undone.")) {
            const response = await fetch(`/users/${userId}`, { method: 'DELETE' });
            if (response.ok) {
                alert("Account deleted.");
                localStorage.clear();
                window.location.href = '/login-ui';
            }
        }
    });

    loadProfile();
</script>
{% endblock %}